{%raw%}

## 上下文处理器

上下文处理器是可以返回一些数据，在全局模板中都可以使用。比如登录后的用户信息，在很多页面中都需要使用，那么我们可以放在上下文处理器中，就没有必要在每个视图函数中都返回这个对象。

在`settings.TEMPLATES.OPTIONS.context_processors`中，有许多内置的上下文处理器。这些上下文处理器的作用如下：

1. `django.template.context_processors.debug`：增加一个`debug`和`sql_queries`变量。在模板中可以通过他来查看到一些数据库查询。

2. `django.template.context_processors.request`：增加一个`request`变量。这个`request`变量也就是在视图函数的第一个参数。

3. `django.contrib.auth.context_processors.auth`：`Django`有内置的用户系统，这个上下文处理器会增加一个`user`对象。

4. `django.contrib.messages.context_processors.messages`：增加一个`messages`变量。

5. ```
   django.template.context_processors.media
   ```

   ：在模板中可以读取

   ```
   MEDIA_URL
   ```

   。比如想要在模板中使用上传的文件，那么这时候就需要使用

   ```
   settings.py
   ```

   中设置的

   ```
   MEDIA_URL
   ```

   来拼接

   ```
   url
   ```

   。示例代码如下：

   ```html
   <img src="" />
   ```

6. `django.template.context_processors.static`：在模板中可以使用`STATIC_URL`。

7. `django.template.context_processors.csrf`：在模板中可以使用`csrf_token`变量来生成一个`csrf token`。

```python
#手打代码
views.py
from django.shortcuts import render,redirect,reverse
from django.http import HttpResponse
from django.views.generic import View
from .forms import SignupForm,SigninForm
from .models import User
from django.template.context_processors import debug,request
from django.contrib.auth.context_processors import auth
# Create your views here.

def index(request):
    # user_id = request.session.get('user_id')
    # context={
    #
    # }
    # #这里的user_id并不一定存在，如果不存在None就会抛出异常
    # try:
    #     user = User.objects.get(pk=user_id)
    #     context['front_user'] = user
    # except:
    #     pass
    users = User.objects.all()
    for user in users:
        print(user)
    return render(request,'index.html')


#登录类视图
class SigninView(View):
    def get(self,request):
        return render(request,'signin.html')

    def post(self,request):
        form = SigninForm(request.POST)
        if form.is_valid():
            username = form.cleaned_data.get('username')
            password = form.cleaned_data.get('password')
            user = User.objects.filter(username=username,password=password).first()
            if user:
                request.session['user_id'] = user.id
                return redirect(reverse('index'))
            else:
                print('用户或密码错误')
                return redirect(reverse('signin'))
        else:
            print('填写错误')
            return redirect(reverse('signin'))


class SignupView(View):
    def get(self,request):
        return render(request,'signup.html')

    def post(self,request):
        form = SignupForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect(reverse('index'))
        else:
            errors = form.errors.get_json_data()
            print(errors)
            return redirect(reverse('signup'))

def blog(request):
    return render(request,'blog.html')

def video(request):
    return render(request,'video.html')

#forms.py
#验证提交的数据是否正确

from django import forms
from .models import User
class SignupForm(forms.ModelForm):
    #这里面还需要补表单中的字段验证
    password_repeat = forms.CharField(max_length=16,min_length=6)

    #重写clean方法
    def clean(self):
        #清洗数据
        cleaned_data =super(SignupForm, self).clean()
        password = cleaned_data.get('password')
        password_repeat = cleaned_data.get('password_repeat')
        if password != password_repeat:
            raise forms.ValidationError(message='两次密码输入不一致')
        return cleaned_data


    class Meta:
        model = User

        #验证所有的字段
        fields = '__all__'

#验证登录的表单
class SigninForm(forms.ModelForm):
    class Meta:
        model =User

        #输入验证的字段
        fields =['username','password']

#models.py
from django.db import models

# Create your models here.
class User(models.Model):
    username = models.CharField(max_length=100)
    password = models.CharField(max_length=16)
    telephone = models.CharField(max_length=11)
    
#settings.py
"""
Django settings for context_process_demo project.

Generated by 'django-admin startproject' using Django 3.0.6.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import os

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '$vd(_nladu+t07o=4fg37#^9x2_dx8wevhb8$=ffl0&$x6luzo'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'front',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    #'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'context_process_demo.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                #后面加上自己的上下文处理器
                'front.context_processors.front_user'

            ],
        },
    },
]

WSGI_APPLICATION = 'context_process_demo.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATIC_URL = '/static/'

INTERNAL_IPS =['127.0.0.1']


#context_processors.py
from .models import User

#上下文处理器
#需要在settings中进行添加配置
def front_user(request):
    user_id = request.session.get('user_id')
    context ={

    }
    if user_id:
        try:
            user =User.objects.get(pk=user_id)
            context['front_user'] = user
        except:
            pass
    return context

#template
#base.html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <title>知了课堂</title>
</head>
<body>
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="{% url 'index' %}">知了课堂</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="active"><a href="/">首页 <span class="sr-only">(current)</span></a></li>
        <li><a href="{% url 'blog' %}">博客 <span class="sr-only">(current)</span></a></li>
        <li><a href="{% url 'video' %}">视频 <span class="sr-only">(current)</span></a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
          {% if front_user %}
                <li><a href="#">{{ front_user.username }}</a></li>
          {% else %}
                <li><a href="{% url 'signin'%}">登录</a></li>
                <li><a href="{% url 'signup' %}">注册</a></li>
          {% endif %}
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
{% block body %}

{% endblock %}
</body>
</html>

#index.html
{% extends 'base.html' %}
{% block  body %}
<h1>你好</h1>{{ debug }}/{{ sql_queries }}<br>
    {{ request.path }}
{% endblock %}

#signup.html
{% extends 'base.html' %}
{% block body %}
     <form action="" method="post">
    <table>
        <tbody>
        <tr>
            <td>用户名：</td>
            <td><input type="text" name="username"></td>
        </tr>
        <tr>
            <td>手机号码：</td>
            <td><input type="text" name="telephone"></td>
        </tr>
         <tr>
            <td>密码：</td>
            <td><input type="password" name="password"></td>
        </tr>
         <tr>
            <td>重复密码：</td>
            <td><input type="password" name="password_repeat"></td>
        </tr>
         <tr>
            <td></td>
            <td><input type="submit" value="注册"></td>
        </tr>
        </tbody>
    </table>
    </form>
{% endblock %}
```



## 自定义上下文处理器：

有时候我们想要返回自己的数据。那么这时候我们可以自定义上下文处理器。自定义上下文处理器的步骤如下：

1. 你可以根据这个上下文处理器是属于哪个`app`，然后在这个`app`中创建一个文件专门用来存储上下文处理器。比如`context_processors.py`。或者是你也可以专门创建一个`Python包`，用来存储所有的上下文处理器。

2. 在你定义的上下文处理器文件中，定义一个函数，这个函数只有一个

   ```
   request
   ```

   参数。这个函数中处理完自己的逻辑后，把需要返回给模板的数据，通过字典的形式返回。如果不需要返回任何数据，那么也必须返回一个空的字典。示例代码如下：

   ```python
    def frontuser(request):
      userid = request.session.get("userid")
      userModel = models.FrontendUser.objects.filter(pk=userid).first()
      if userModel:
        return {'frontuser':userModel}
      else:
        return {}
   ```

{%endraw%}